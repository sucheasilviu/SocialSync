import sqlite3
import requests
from bs4 import BeautifulSoup
import os
import time
import json
from openai import OpenAI # <--- Modificare 1: Importam OpenAI

# --- CONFIGURARE ---
# Cheia ta OpenAI (începe cu sk-...)
API_KEY = 

FOLDER_TEXTE = "data_raw"
NUME_DB = "events.db"

# LINK-URI
urls_de_procesat = [
    "https://www.zilesinopti.ro/articole/top-10-restaurante-bucuresti/",
    "https://m.iabilet.ro/bilete-in-bucuresti/"
]

# Inițializare Client OpenAI
client = OpenAI(api_key=API_KEY)

def setup_db():
    conn = sqlite3.connect(NUME_DB)
    cursor = conn.cursor()
    cursor.execute("DROP TABLE IF EXISTS evenimente")
    cursor.execute("""
        CREATE TABLE evenimente (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            nume_eveniment TEXT,
            pret REAL,
            data_ora TEXT,
            locuri_disponibile INTEGER,
            categorie TEXT,
            sursa_url TEXT
        )
    """)
    conn.commit()
    return conn

def extract_structured_data(text_articol):
    """
    Versiunea OpenAI: Folosește JSON Mode pentru precizie maximă.
    """
    
    system_prompt = """
    Ești un asistent Data Engineer. Sarcina ta este să extragi date structurate din text.
    Trebuie să răspunzi DOAR cu un obiect JSON valid, fără alte comentarii.
    Schema JSON cerută:
    {
        "nume": "string",
        "pret": number (0 daca nu e gasit),
        "data": "YYYY-MM-DD HH:MM" (sau "Unknown"),
        "locuri": number (estimat sau 0),
        "categorie": "string"
    }
    """

    user_message = f"""
    Analizează textul și extrage datele:
    {text_articol[:4000]} 
    """
    
    try:
        response = client.chat.completions.create(
            model="gpt-4o-mini", # <--- Modificare 2: Modelul (rapid si ieftin)
            messages=[
                {"role": "system", "content": system_prompt},
                {"role": "user", "content": user_message}
            ],
            response_format={"type": "json_object"}, # <--- Modificare 3: Fortam JSON pur
            temperature=0.1 # <--- Modificare 4: Creativitate mică, precizie mare
        )
        
        # Parsăm răspunsul
        json_str = response.choices[0].message.content
        data = json.loads(json_str)
        return data

    except Exception as e:
        print(f"   [OpenAI Error] {e}")
        return {"nume": "Eroare Extracție", "pret": 0, "data": "N/A", "locuri": 0, "categorie": "Eroare"}

def process_workflow():
    if not os.path.exists(FOLDER_TEXTE):
        os.makedirs(FOLDER_TEXTE)

    conn = setup_db()
    cursor = conn.cursor()
    
    print(f"--- Încep Procesarea cu OPENAI ({len(urls_de_procesat)} link-uri) ---")

    headers = {'User-Agent': 'Mozilla/5.0'}

    for url in urls_de_procesat:
        try:
            print(f"\n1. Descarc: {url}...")
            response = requests.get(url, headers=headers, timeout=10)
            
            if response.status_code != 200:
                print("   [!] Skip Link")
                continue
            
            # --- RAG (Text) ---
            soup = BeautifulSoup(response.content, 'html.parser')
            titlu = soup.find('h1').get_text().strip() if soup.find('h1') else "Eveniment"
            
            text_body = ""
            for p in soup.find_all('p'):
                text_body += p.get_text().strip() + "\n"
            
            full_text = f"Sursa: {url}\nTitlu: {titlu}\n\n{text_body}"
            
            nume_fisier = "".join([c if c.isalnum() else "_" for c in titlu[:20]]) + ".txt"
            with open(os.path.join(FOLDER_TEXTE, nume_fisier), "w", encoding="utf-8") as f:
                f.write(full_text)
            print(f"   [RAG] Text salvat.")

            # --- SQL (OpenAI Extraction) ---
            print("   [AI] OpenAI analizează prețul...")
            data_structurata = extract_structured_data(full_text)
            
            cursor.execute("""
                INSERT INTO evenimente (nume_eveniment, pret, data_ora, locuri_disponibile, categorie, sursa_url)
                VALUES (?, ?, ?, ?, ?, ?)
            """, (
                data_structurata.get("nume"),
                data_structurata.get("pret"),
                data_structurata.get("data"),
                data_structurata.get("locuri"),
                data_structurata.get("categorie"),
                url
            ))
            print(f"   [SQL] Inserat: {data_structurata.get('nume')} | Preț: {data_structurata.get('pret')}")

        except Exception as e:
            print(f"   [!] Eroare: {e}")

    conn.commit()
    conn.close()
    print("\n[GATA] Totul este pregătit cu OpenAI!")

if __name__ == "__main__":
    process_workflow()
